name: GCP CI - Pre-Deployment Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  terraform-format-check:
    name: Check Terraform Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.x

      - name: Verify formatting
        run: |
          terraform fmt -check -recursive . || exit 1
          echo "âœ“ All Terraform files are formatted"

  go-validity:
    name: Go Build & Tests
    runs-on: ubuntu-latest
    needs: [terraform-format-check]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'
          cache: true

      - name: Build Go binary
        working-directory: ./function
        run: |
          go build -o /tmp/llm-proxy .
          echo "âœ“ Build successful"

      - name: Run tests
        working-directory: ./function
        run: |
          go test -v ./... -timeout 10m
          echo "âœ“ Tests passed"

  code-quality:
    name: Lint & Security Scan
    runs-on: ubuntu-latest
    needs: [go-validity]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: ./function
          args: --timeout=5m

      - name: Check for secrets
        run: |
          echo "ðŸ” Checking git diff for secrets..."
          git diff --cached --name-only | grep -E '\.tf$|\.go$' || true
        continue-on-error: true

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [terraform-format-check, go-validity, code-quality]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# PR Summary" > $GITHUB_STEP_SUMMARY
          echo "âœ… All CI checks passed!" >> $GITHUB_STEP_SUMMARY

      - name: Add deployment instructions
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“ To Deploy:
          ```bash
          make init-terraform
          make deploy
          ```
          EOF

      - name: Add review guidelines
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“‹ Code Review Checklist:
          - ðŸ”„ Follow existing code style
          - ðŸ” Check for hardcoded secrets
          - âœ… Ensure all tests pass
          - ðŸ“š Update documentation if needed
          - ðŸ”’ Verify security implications
          EOF